/*********************************************************************
 *
 *   main.c
 *
 *********************************************************************/

/*--------------------------------------------------------------------
                           GENERAL INCLUDES
--------------------------------------------------------------------*/
#include <assert.h>
#include <string.h>
#include <stdio.h>
#include "packet_processor.h"

/*--------------------------------------------------------------------
                          LITERAL CONSTANTS
--------------------------------------------------------------------*/
uint8_t dummy_data_one[10][PACKET_LENGTH] = {
    // Version=1, packet_id=1, base_epoch=1617887200
    {0x01, 0x01, 0x60, 0x91, 0xC0, 0x00, 0x01, 0x02, 0x10, 0x41, 0x00, 0x00, 0x00, 0x12, 0xFF, 0xEE, 0x02, 0x03, 0xFF, 0x44},

    // Version=2, packet_id=2, base_epoch=1617887300
    {0x02, 0x02, 0x60, 0x91, 0xC0, 0x00, 0x10, 0x20, 0x30, 0x42, 0x00, 0x00, 0x00, 0x13, 0xF0, 0xCC, 0x03, 0x04, 0xFE, 0x55},

    // Version=3, packet_id=3, base_epoch=1617887400
    {0x03, 0x03, 0x60, 0x91, 0xC0, 0x00, 0x21, 0x32, 0x43, 0x43, 0x01, 0x00, 0x00, 0x14, 0xAA, 0xBB, 0x04, 0x05, 0xFE, 0x66},

    // Version=4, packet_id=4, base_epoch=1617887500
    {0x04, 0x04, 0x60, 0x91, 0xC0, 0x00, 0x31, 0x43, 0x53, 0x44, 0x02, 0x00, 0x00, 0x15, 0xBB, 0xCC, 0x05, 0x06, 0xFD, 0x77},

    // Version=5, packet_id=5, base_epoch=1617887600
    {0x05, 0x05, 0x60, 0x91, 0xC0, 0x00, 0x41, 0x54, 0x64, 0x45, 0x03, 0x00, 0x00, 0x16, 0xCC, 0xDD, 0x06, 0x07, 0xFB, 0x88},

    // Version=6, packet_id=6, base_epoch=1617887700
    {0x06, 0x06, 0x60, 0x91, 0xC0, 0x00, 0x51, 0x64, 0x75, 0x46, 0x04, 0x00, 0x00, 0x17, 0xDD, 0xEE, 0x07, 0x08, 0xFA, 0x99},

    // Version=7, packet_id=7, base_epoch=1617887800
    {0x07, 0x07, 0x60, 0x91, 0xC0, 0x00, 0x61, 0x75, 0x86, 0x47, 0x05, 0x00, 0x00, 0x18, 0xEE, 0xFF, 0x08, 0x09, 0xF9, 0xAA},

    // Version=8, packet_id=8, base_epoch=1617887900
    {0x08, 0x08, 0x60, 0x91, 0xC0, 0x00, 0x71, 0x86, 0x97, 0x48, 0x06, 0x00, 0x00, 0x19, 0xFF, 0x00, 0x09, 0x0A, 0xF8, 0xBB},

    // Version=9, packet_id=9, base_epoch=1617888000
    {0x09, 0x09, 0x60, 0x91, 0xC0, 0x00, 0x81, 0x97, 0xA8, 0x49, 0x07, 0x00, 0x00, 0x1A, 0x00, 0x11, 0x0A, 0x0B, 0xF7, 0xCC},

    // Version=10, packet_id=10, base_epoch=1617888100
    {0x0A, 0x0A, 0x60, 0x91, 0xC0, 0x00, 0x91, 0xA8, 0xB9, 0x4A, 0x08, 0x00, 0x00, 0x1B, 0x11, 0x22, 0x0B, 0x0C, 0xF6, 0xDD}
};

uint8_t dummy_data_two[10][PACKET_LENGTH] = {
    // Version=1, packet_id=250, base_epoch=1617887200
    {0x01, 0xFA, 0x60, 0x91, 0xC0, 0x00, 0x01, 0x02, 0x10, 0x41, 0x00, 0x00, 0x00, 0x12, 0xFF, 0xEE, 0x02, 0x03, 0xFF, 0x44},

    // Version=2, packet_id=251, base_epoch=1617887300
    {0x02, 0xFB, 0x60, 0x91, 0xC0, 0x00, 0x10, 0x20, 0x30, 0x42, 0x00, 0x00, 0x00, 0x13, 0xF0, 0xCC, 0x03, 0x04, 0xFE, 0x55},

    // Version=3, packet_id=252, base_epoch=1617887400
    {0x03, 0xFC, 0x60, 0x91, 0xC0, 0x00, 0x21, 0x32, 0x43, 0x43, 0x01, 0x00, 0x00, 0x14, 0xAA, 0xBB, 0x04, 0x05, 0xFE, 0x66},

    // Version=4, packet_id=253, base_epoch=1617887500
    {0x04, 0xFD, 0x60, 0x91, 0xC0, 0x00, 0x31, 0x43, 0x53, 0x44, 0x02, 0x00, 0x00, 0x15, 0xBB, 0xCC, 0x05, 0x06, 0xFD, 0x77},

    // Version=5, packet_id=254, base_epoch=1617887600
    {0x05, 0xFE, 0x60, 0x91, 0xC0, 0x00, 0x41, 0x54, 0x64, 0x45, 0x03, 0x00, 0x00, 0x16, 0xCC, 0xDD, 0x06, 0x07, 0xFB, 0x88},

    // Version=6, packet_id=255, base_epoch=1617887700
    {0x06, 0xFF, 0x60, 0x91, 0xC0, 0x00, 0x51, 0x64, 0x75, 0x46, 0x04, 0x00, 0x00, 0x17, 0xDD, 0xEE, 0x07, 0x08, 0xFA, 0x99},

    // Version=7, packet_id=1, base_epoch=1617887800
    {0x07, 0x01, 0x60, 0x91, 0xC0, 0x00, 0x61, 0x75, 0x86, 0x47, 0x05, 0x00, 0x00, 0x18, 0xEE, 0xFF, 0x08, 0x09, 0xF9, 0xAA},

    // Version=8, packet_id=2, base_epoch=1617887900
    {0x08, 0x02, 0x60, 0x91, 0xC0, 0x00, 0x71, 0x86, 0x97, 0x48, 0x06, 0x00, 0x00, 0x19, 0xFF, 0x00, 0x09, 0x0A, 0xF8, 0xBB},

    // Version=9, packet_id=3, base_epoch=1617888000
    {0x09, 0x03, 0x60, 0x91, 0xC0, 0x00, 0x81, 0x97, 0xA8, 0x49, 0x07, 0x00, 0x00, 0x1A, 0x00, 0x11, 0x0A, 0x0B, 0xF7, 0xCC},

    // Version=10, packet_id=4, base_epoch=1617888100
    {0x0A, 0x04, 0x60, 0x91, 0xC0, 0x00, 0x91, 0xA8, 0xB9, 0x4A, 0x08, 0x00, 0x00, 0x1B, 0x11, 0x22, 0x0B, 0x0C, 0xF6, 0xDD}
};

#define NUM_PACKETS 10
uint8_t tspv_posted_count = 0;

/*--------------------------------------------------------------------
                              PROCEDURES
--------------------------------------------------------------------*/
uint8_t* requestOldPacket(uint8_t packetid) {
	return dummy_data_one[packetid - 1]; // TODO: Update to use any data array
}

void postTSPV(uint8_t stat1, uint8_t stat2, float pv) {
	// Mock function to simulate posting TSPV
	tspv_posted_count++;
}

/*--------------------------------------------------------------------
                              HELPER PROCEDURES
--------------------------------------------------------------------*/

// Helper function for packet processing
void processPackets(int* packet_indices, int num_packets) {
    for (int i = 0; i < num_packets; i++) {
        receiveMSG(dummy_data_one[packet_indices[i]], PACKET_LENGTH);
    }
}

// Common test function that processes packets and checks the expected TSPV count
void runPacketTest(int* packet_indices, int num_packets, int expected_tspv_count, const char* test_description) {
    tspv_posted_count = 0;
    resetProcessor();

    // Process specified packets
    processPackets(packet_indices, num_packets);

    // Check if the expected TSPVs match
    assert(tspv_posted_count == expected_tspv_count);

    printf("Test Passed: %s\n", test_description);
}

/*--------------------------------------------------------------------
							  UNIT TESTS
--------------------------------------------------------------------*/

void unitTEST1() {
    // Test case: Normal packet processing

    int packet_indices[] = { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 }; // All packets
    runPacketTest(
        packet_indices,
        sizeof(packet_indices) / sizeof(packet_indices[0]),
        NUM_PACKETS * 2,
        "Normal Packet Processing"
    );
}

void unitTEST2() {
    // Test case: Skipped packets

    int packet_indices[] = { 0, 1, 3, 4, 6, 7, 9 }; // Skipping packets 3, 5, 8
    runPacketTest(
        packet_indices,
        sizeof(packet_indices) / sizeof(packet_indices[0]),
        NUM_PACKETS * 2,
        "Skipped Packets"
    );
}

void unitTEST3() {
    // Test case: Skip more packets than the device can store (4)

    int packet_indices[] = { 0, 5, 6, 7, 8, 9 }; // Skipping packets 1, 2, 3, 4
    runPacketTest(
        packet_indices,
        sizeof(packet_indices) / sizeof(packet_indices[0]),
        (NUM_PACKETS - 1) * 2,
        "Missing Packets"
    );
}

void unitTEST4() {
    // Test case: Missed first few packets

    int packet_indices[] = { 4, 5, 6, 7, 8, 9 }; // Skipping first 4 packets
    runPacketTest(
        packet_indices,
        sizeof(packet_indices) / sizeof(packet_indices[0]),
        (NUM_PACKETS - 1) * 2,
        "Missing First Packets"
    );
}

void unitTEST5() {
	// Test case: packet_id wrapping (WIP)

	int packet_indices[] = { 4, 5, 6, 7, 8, 9 };
	runPacketTest(
		packet_indices,
		sizeof(packet_indices) / sizeof(packet_indices[0]),
		NUM_PACKETS * 2,
		"Packet ID Wrapping"
	);
}

/*--------------------------------------------------------------------
							  MAIN PROCEDURE
--------------------------------------------------------------------*/
int main() {
    unitTEST1();
    unitTEST2();
    unitTEST3();
	unitTEST4();
	//unitTEST5(); // WIP

    printf("All Unit Tests Passed Successfully!\n");
    return 0;
}